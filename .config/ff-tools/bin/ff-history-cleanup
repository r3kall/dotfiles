#!/usr/bin/env bash
set -euo pipefail

# ff-history-cleanup
# Prune Firefox history older than N days (default 15).
#
# Usage:
#   ff-history-cleanup --profile DIR [--days N] [--debug]
#
# Env:
#   FF_PROFILE        Alternative to --profile
#   FF_TOOLS_DIR      Default: ~/.config/ff-tools

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/ff-tools.sh"

ff_need_cmd sqlite3
ff_need_cmd python

FF_DEBUG="${FF_DEBUG:-0}"
FF_TOOLS_DIR="${FF_TOOLS_DIR:-$HOME/.config/ff-tools}"
PROFILE="${FF_PROFILE:-}"
DAYS=15

usage() {
  cat <<'EOF'
Usage:
  ff-history-cleanup --profile DIR [--days N] [--debug]

Options:
  --profile DIR        Firefox profile directory (contains places.sqlite)
  --days N             Keep last N days of history (default: 15)
  --debug              Enable debug logs

EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -p|--profile) PROFILE="${2:-}"; shift 2;;
    -d|--days) DAYS="${2:-}"; shift 2;;
    --debug) FF_DEBUG=1; shift;;
    -h|--help) usage; exit 0;;
    *) ff_die "unknown arg: $1";;
  esac
done

[[ -n "$PROFILE" ]] || ff_die "PROFILE not set (use --profile or FF_PROFILE)"
[[ "$DAYS" =~ ^[0-9]+$ ]] || ff_die "--days must be a non-negative integer"

DB="$PROFILE/places.sqlite"
[[ -f "$DB" ]] || ff_die "places.sqlite not found: $DB"

ff_assert_firefox_not_running

CUTOFF_US="$(ff_cutoff_epoch_us_days_ago "$DAYS")"

sqlite3 "$DB" <<SQL
PRAGMA foreign_keys=ON;
BEGIN IMMEDIATE;

DELETE FROM moz_historyvisits
WHERE visit_date < $CUTOFF_US;

DELETE FROM moz_places
WHERE id IN (
  SELECT p.id
  FROM moz_places p
  LEFT JOIN moz_historyvisits v ON v.place_id = p.id
  LEFT JOIN moz_bookmarks b ON b.fk = p.id
  WHERE v.id IS NULL AND b.id IS NULL
);

DELETE FROM moz_inputhistory
WHERE place_id NOT IN (SELECT id FROM moz_places);

COMMIT;
VACUUM;
SQL

echo "OK: history cleaned"
echo "  profile: $PROFILE"
echo "  cutoff : ${DAYS} days"
