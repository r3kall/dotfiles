#!/usr/bin/env bash
set -euo pipefail

# ff-profile-path
# Print the filesystem path of the default Firefox profile (native + Flatpak).
#
# Preference order per base directory:
#   1) installs.ini Default=... (prefer Locked=1)
#   2) profiles.ini Default=1
#   3) first profile in profiles.ini
#   4) newest likely profile directory
#
# Usage:
#   ff-profile-path [--base DIR] [--debug] [--list-bases]

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../lib/ff-tools.sh
source "$SCRIPT_DIR/../lib/ff-tools.sh"

BASES=(
  "$HOME/.mozilla/firefox"
  "$HOME/.var/app/org.mozilla.firefox/.mozilla/firefox"
)

BASE=""
FF_DEBUG="${FF_DEBUG:-0}"

usage() {
  cat <<'EOF'
Usage:
  ff-profile-path [--base DIR] [--debug] [--list-bases]

Options:
  --base DIR       Search only this Firefox base dir
  --debug          Enable debug logs (stderr)
  --list-bases     Print default searched base dirs and exit
EOF
}

install_default() {
  local installs="$1"
  [[ -f "$installs" ]] || return 1

  awk -F= '
    function flush() {
      if (!in_sec) return
      if (locked=="1" && def!="") { best=def; best_locked=1 }
      else if (best=="" && def!="") { best=def }
      in_sec=0; def=""; locked="0"
    }
    BEGIN { in_sec=0; def=""; locked="0"; best=""; best_locked=0 }
    /^\[Install/ { flush(); in_sec=1; next }
    in_sec && /^Default=/ { def=$2; next }
    in_sec && /^Locked=/  { locked=$2; next }
    END { flush(); if (best!="") print best }
  ' "$installs" | ff_trim
}

profiles_default() {
  local profiles="$1" base="$2"
  [[ -f "$profiles" ]] || return 1
  awk -F= -v base="$base" '
    function flush() {
      if (!in_prof) return
      if (def=="1" && path!="") {
        if (rel=="1") print base "/" path
        else print path
        exit
      }
      in_prof=0; path=""; rel="1"; def="0"
    }
    BEGIN { in_prof=0; path=""; rel="1"; def="0" }
    /^\[Profile/ { flush(); in_prof=1; next }
    in_prof && /^Path=/       { path=$2; next }
    in_prof && /^IsRelative=/ { rel=$2; next }
    in_prof && /^Default=/    { def=$2; next }
    /^$/ { flush(); next }
    END { flush() }
  ' "$profiles" | ff_trim
}

profiles_first() {
  local profiles="$1" base="$2"
  [[ -f "$profiles" ]] || return 1
  awk -F= -v base="$base" '
    function emit() {
      if (!in_prof) return
      if (path!="") {
        if (rel=="1") print base "/" path
        else print path
        exit
      }
      in_prof=0; path=""; rel="1"
    }
    BEGIN { in_prof=0; path=""; rel="1" }
    /^\[Profile/ { emit(); in_prof=1; next }
    in_prof && /^Path=/       { path=$2; next }
    in_prof && /^IsRelative=/ { rel=$2; next }
    /^$/ { emit(); next }
    END { emit() }
  ' "$profiles" | ff_trim
}

latest_profile_dir() {
  local base="$1"
  local p=""
  p="$(ls -1td "$base"/*.default* "$base"/*.daily "$base"/*.release 2>/dev/null | head -n1 || true)"
  [[ -n "$p" && -d "$p" ]] && printf '%s\n' "$p"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --base) BASE="${2:-}"; shift 2;;
    --debug) FF_DEBUG=1; shift;;
    --list-bases) printf "%s\n" "${BASES[@]}"; exit 0;;
    -h|--help) usage; exit 0;;
    *) ff_die "unknown arg: $1";;
  esac
done

[[ -n "$BASE" ]] && BASES=("$BASE")

for base in "${BASES[@]}"; do
  installs="$base/installs.ini"
  profiles="$base/profiles.ini"

  ff_log "base=$base"

  if [[ -f "$installs" ]]; then
    id="$(install_default "$installs" || true)"
    if [[ -n "$id" ]]; then
      id="${id#Profiles/}"
      if [[ "$id" = /* && -d "$id" ]]; then
        echo "$id"; exit 0
      fi
      if [[ -d "$base/$id" ]]; then
        echo "$base/$id"; exit 0
      fi
    fi
  fi

  if [[ -f "$profiles" ]]; then
    p="$(profiles_default "$profiles" "$base" || true)"
    [[ -n "$p" && -d "$p" ]] && { echo "$p"; exit 0; }

    p="$(profiles_first "$profiles" "$base" || true)"
    [[ -n "$p" && -d "$p" ]] && { echo "$p"; exit 0; }
  fi

  p="$(latest_profile_dir "$base" || true)"
  [[ -n "$p" && -d "$p" ]] && { echo "$p"; exit 0; }
done

ff_die "could not find a Firefox profile. Use --base to specify."
